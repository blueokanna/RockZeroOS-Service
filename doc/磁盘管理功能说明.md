# RockZero OS 磁盘管理功能说明

## 问题解决

你提出的问题已经全部解决：

### ✅ 1. 不显示 VFAT 格式的磁盘
- 系统现在会自动过滤 VFAT、FAT32、FAT16、FAT 格式的磁盘
- 这些通常是 /boot 分区，不应该在用户界面显示
- 在 Storage 页面和 Files 页面都已过滤

### ✅ 2. 正确挂载硬盘
- 添加了自动挂载服务，系统启动时自动挂载所有外部磁盘
- 添加了手动挂载功能，在 UI 界面点击未挂载的磁盘即可挂载
- 支持多种文件系统：ext4、NTFS、exFAT、btrfs、XFS

### ✅ 3. 在 Files 界面正确显示
- 挂载成功的磁盘会显示在 Storage Devices 列表中
- 点击磁盘卡片可以进入文件浏览
- 可以查看、上传、下载、删除文件

### ✅ 4. 关机前数据保护
- 添加了安全关机服务，关机前自动同步所有数据
- 多次执行 sync 命令确保数据写入
- 刷新磁盘缓存
- 安全卸载外部磁盘

## 修改的文件

### 后端 (Rust)
1. **src/handlers/system.rs**
   - 添加 VFAT/FAT 格式过滤
   - 调整磁盘排序逻辑

### 前端 (Flutter)
1. **RockZeroOS-UI/lib/features/files/presentation/pages/files_page.dart**
   - 显示所有磁盘（包括未挂载的）
   - 添加挂载对话框
   - 添加挂载功能
   - 过滤 VFAT 格式磁盘

### 系统脚本（新建）
1. **scripts/auto-mount-disks.sh**
   - 自动挂载所有外部磁盘
   - 跳过 VFAT/FAT 格式
   - 支持多种文件系统

2. **scripts/safe-shutdown.sh**
   - 关机前数据同步
   - 刷新磁盘缓存
   - 安全卸载磁盘

### 系统服务（新建）
1. **rockzero-automount.service**
   - 系统启动时自动挂载

2. **rockzero-safe-shutdown.service**
   - 系统关机前数据保护

### 文档（新建）
1. **DISK_MANAGEMENT.md** - 详细使用文档
2. **QUICK_INSTALL.md** - 快速安装指南
3. **CHANGES_SUMMARY.md** - 修改总结

## 安装方法

### 方法 1：一键安装（推荐）

```bash
# 1. 进入项目目录
cd /path/to/rockzero

# 2. 运行部署脚本
sudo ./scripts/deploy-armbian.sh
```

### 方法 2：手动安装

```bash
# 1. 复制文件到系统目录
sudo cp -r . /opt/rockzero/

# 2. 设置脚本权限
sudo chmod +x /opt/rockzero/scripts/*.sh

# 3. 安装自动挂载服务
sudo cp /opt/rockzero/rockzero-automount.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable rockzero-automount.service
sudo systemctl start rockzero-automount.service

# 4. 安装安全关机服务
sudo cp /opt/rockzero/rockzero-safe-shutdown.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable rockzero-safe-shutdown.service

# 5. 验证安装
sudo systemctl status rockzero-automount
sudo systemctl status rockzero-safe-shutdown
```

## 使用方法

### 自动挂载
系统启动后会自动挂载所有外部磁盘，无需手动操作。

查看挂载状态：
```bash
# 查看所有磁盘
lsblk

# 查看挂载点
mount | grep /mnt

# 查看服务状态
sudo systemctl status rockzero-automount
```

### 手动挂载（UI 界面）

1. 打开 RockZero OS UI
2. 进入 **Files** 页面
3. 查看 **Storage Devices** 部分
4. 点击显示 "Not mounted" 的磁盘
5. 在弹出的对话框中点击 **Mount** 按钮
6. 等待挂载完成
7. 刷新页面，磁盘会显示在列表中
8. 点击磁盘卡片即可浏览文件

### 手动挂载（命令行）

```bash
# 运行自动挂载脚本
sudo /opt/rockzero/scripts/auto-mount-disks.sh
```

### 安全关机

```bash
# 方法 1：使用系统关机命令（推荐）
# 服务会自动运行安全关机脚本
sudo shutdown -h now

# 方法 2：手动运行安全关机脚本
sudo /opt/rockzero/scripts/safe-shutdown.sh
# 然后关机
sudo shutdown -h now
```

## 功能特性

### 1. 自动挂载
- ✅ 系统启动时自动挂载
- ✅ 支持 ext4、NTFS、exFAT、btrfs、XFS
- ✅ 自动跳过 VFAT/FAT 格式（启动分区）
- ✅ 自动跳过 swap 分区
- ✅ 自动设置权限

### 2. 手动挂载
- ✅ UI 界面点击挂载
- ✅ 显示磁盘信息（大小、类型、文件系统）
- ✅ 挂载进度提示
- ✅ 挂载成功/失败反馈

### 3. 安全关机
- ✅ 自动同步所有数据
- ✅ 刷新磁盘缓存
- ✅ 安全卸载外部磁盘
- ✅ 防止数据丢失

### 4. UI 改进
- ✅ 不显示 VFAT 格式磁盘
- ✅ 分离已挂载和未挂载磁盘
- ✅ 显示挂载状态
- ✅ 点击未挂载磁盘弹出挂载对话框

## 挂载位置

所有外部磁盘默认挂载到 `/mnt/` 目录下：

- 如果磁盘有标签：`/mnt/<标签名>`
- 如果磁盘有 UUID：`/mnt/<UUID前8位>`
- 否则：`/mnt/<设备名>`

例如：
- `/mnt/MyDisk` （有标签）
- `/mnt/a1b2c3d4` （有 UUID）
- `/mnt/sda1` （无标签和 UUID）

## 数据安全

### 关机前的保护措施
系统关机时会自动执行：
1. 停止所有文件操作（rsync、cp、mv）
2. 第一次 sync（同步文件系统）
3. 等待 1 秒
4. 第二次 sync
5. 刷新所有磁盘缓存
6. 安全卸载外部磁盘
7. 最终 sync

### 手动数据同步
如果需要手动同步数据：
```bash
# 同步所有文件系统
sync

# 刷新特定磁盘的缓存
sudo blockdev --flushbufs /dev/sda

# 运行完整的安全关机流程（不关机）
sudo /opt/rockzero/scripts/safe-shutdown.sh
```

## 故障排除

### 问题 1：磁盘未自动挂载

**解决方法**：
```bash
# 1. 检查磁盘是否被识别
lsblk

# 2. 检查服务状态
sudo systemctl status rockzero-automount

# 3. 查看服务日志
sudo journalctl -u rockzero-automount -n 50

# 4. 手动运行挂载脚本
sudo /opt/rockzero/scripts/auto-mount-disks.sh

# 5. 检查文件系统类型
sudo blkid
```

### 问题 2：UI 界面不显示磁盘

**解决方法**：
1. 刷新页面
2. 检查后端服务是否运行：`docker ps`
3. 检查浏览器控制台是否有错误
4. 验证 API 连接

### 问题 3：挂载失败

**解决方法**：
```bash
# 1. 检查文件系统类型
sudo blkid /dev/sdX1

# 2. 检查磁盘是否有错误
sudo fsck /dev/sdX1

# 3. 查看系统日志
sudo dmesg | tail -50

# 4. 尝试手动挂载
sudo mkdir -p /mnt/test
sudo mount /dev/sdX1 /mnt/test
```

### 问题 4：磁盘无法卸载

**解决方法**：
```bash
# 1. 检查是否有进程正在使用
sudo lsof /mnt/your-disk

# 2. 结束使用磁盘的进程
sudo kill <PID>

# 3. 强制卸载（谨慎使用）
sudo umount -l /mnt/your-disk
```

## 最佳实践

1. **使用 ext4 文件系统**
   - 在 Linux 系统上性能最佳
   - 完全支持 Linux 权限和特性

2. **定期同步数据**
   - 重要操作后手动运行 `sync`
   - 大文件传输后等待几秒

3. **正确关机**
   - 使用系统关机命令
   - 不要直接断电
   - 等待所有文件操作完成

4. **监控磁盘健康**
   - 定期检查磁盘 SMART 状态
   - 使用 `smartctl` 工具

5. **备份重要数据**
   - 使用多个存储设备备份
   - 定期验证备份完整性

## 技术细节

### 支持的文件系统
- **ext4/ext3/ext2**: Linux 原生文件系统（推荐）
- **NTFS**: Windows 文件系统
- **exFAT**: 跨平台文件系统
- **btrfs**: 高级 Linux 文件系统
- **XFS**: 高性能文件系统

### 挂载选项
- **noatime**: 不更新访问时间，提高性能
- **defaults**: 使用默认挂载选项
- **uid/gid**: 设置文件所有者（NTFS/exFAT）
- **umask**: 设置文件权限掩码
- **compress=zstd**: btrfs 压缩（节省空间）

### 安全关机流程
1. 停止文件操作进程
2. 第一次 sync
3. 等待 1 秒
4. 第二次 sync
5. 刷新所有磁盘缓存
6. 卸载非系统文件系统
7. 最终 sync

## 验证安装

### 1. 检查服务状态
```bash
# 自动挂载服务
sudo systemctl status rockzero-automount

# 安全关机服务
sudo systemctl status rockzero-safe-shutdown
```

### 2. 检查挂载点
```bash
# 查看所有磁盘
lsblk

# 查看挂载点
mount | grep /mnt

# 查看磁盘使用情况
df -h
```

### 3. 测试自动挂载
```bash
# 手动运行挂载脚本
sudo /opt/rockzero/scripts/auto-mount-disks.sh

# 查看输出日志
```

### 4. 测试安全关机
```bash
# 运行安全关机脚本（不会真的关机）
sudo /opt/rockzero/scripts/safe-shutdown.sh

# 查看输出日志
```

### 5. 测试 UI 挂载
1. 打开浏览器访问 RockZero OS UI
2. 进入 Files 页面
3. 查看 Storage Devices
4. 点击未挂载的磁盘
5. 验证挂载对话框显示
6. 点击 Mount 按钮
7. 验证挂载成功

## 注意事项

### ⚠️ 重要提示

1. **数据安全**
   - 始终在关机前等待所有文件操作完成
   - 不要在文件传输过程中强制断电
   - 定期备份重要数据

2. **文件系统**
   - 推荐使用 ext4 文件系统
   - NTFS 和 exFAT 需要额外的驱动支持
   - VFAT/FAT 格式的磁盘会被自动过滤

3. **权限问题**
   - 确保脚本有执行权限
   - 服务需要 root 权限运行

4. **系统兼容性**
   - 主要针对 Armbian/Debian/Ubuntu 系统
   - 其他 Linux 发行版可能需要调整

## 卸载

如果需要卸载磁盘管理功能：

```bash
# 1. 停止并禁用服务
sudo systemctl stop rockzero-automount.service
sudo systemctl disable rockzero-automount.service
sudo systemctl stop rockzero-safe-shutdown.service
sudo systemctl disable rockzero-safe-shutdown.service

# 2. 删除服务文件
sudo rm /etc/systemd/system/rockzero-automount.service
sudo rm /etc/systemd/system/rockzero-safe-shutdown.service

# 3. 重新加载 systemd
sudo systemctl daemon-reload

# 4. 删除脚本（可选）
sudo rm /opt/rockzero/scripts/auto-mount-disks.sh
sudo rm /opt/rockzero/scripts/safe-shutdown.sh
```

## 更新

如果需要更新脚本或服务：

```bash
# 1. 停止服务
sudo systemctl stop rockzero-automount.service

# 2. 更新文件
sudo cp /path/to/new/scripts/*.sh /opt/rockzero/scripts/
sudo chmod +x /opt/rockzero/scripts/*.sh

# 3. 更新服务文件
sudo cp /path/to/new/*.service /etc/systemd/system/
sudo systemctl daemon-reload

# 4. 重启服务
sudo systemctl start rockzero-automount.service
```

## 获取帮助

- 📖 详细文档：[DISK_MANAGEMENT.md](DISK_MANAGEMENT.md)
- 🚀 快速安装：[QUICK_INSTALL.md](QUICK_INSTALL.md)
- 📝 修改总结：[CHANGES_SUMMARY.md](CHANGES_SUMMARY.md)
- 🐛 报告问题：GitHub Issues
- 💬 讨论：GitHub Discussions

## 总结

现在你的 RockZero OS 已经具备完整的磁盘管理功能：

✅ **不显示 VFAT 格式的磁盘** - 自动过滤启动分区
✅ **正确挂载硬盘** - 自动挂载 + 手动挂载
✅ **在 Files 界面正确显示** - 可以浏览和管理文件
✅ **关机前数据保护** - 自动同步和安全卸载

所有功能都经过精心设计，确保数据安全和系统稳定性。
